<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Attendance System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/theme.css') }}" rel="stylesheet">
</head>
<body>
    <div class="top-right-controls">
        <a href="/about" class="top-right-control">
            <i class="fas fa-info-circle"></i>
        </a>
        <button class="theme-toggle top-right-control" id="themeToggle">
            <i class="fas fa-moon"></i>
        </button>
    </div>

    <div class="centered">
        <h1 class="animated-fade-in">Smart Attendance System</h1>
        <div class="card animated-slide-in-up" style="max-width: 700px;">
            <div class="card-body text-center">
                <h2 class="mb-4">Control Panel</h2>
                <div id="messageContainer" class="mb-4"></div>
                <div class="d-grid gap-3 col-md-8 mx-auto">
                    <button class="btn btn-success btn-lg" id="startBtn">
                        <i class="fas fa-play-circle me-2"></i> Start Attendance
                    </button>
                    <button class="btn btn-danger btn-lg" id="stopBtn">
                        <i class="fas fa-stop-circle me-2"></i> Stop Attendance
                    </button>
                    <a href="/view_attendance" class="btn btn-primary btn-lg mt-3">
                        <i class="fas fa-eye me-2"></i> View Attendance
                    </a>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
    <script>
        let isRunning = false;
        let attendanceInterval;
        let autoStopTimeout;

        const messageContainer = document.getElementById('messageContainer');

        function showMessage(message, type) {
            messageContainer.innerHTML = `
                <div class="alert alert-${type} animated-fade-in" role="alert">
                    ${message}
                </div>
            `;
            // Automatically remove message after 5 seconds
            setTimeout(() => {
                messageContainer.innerHTML = '';
            }, 5000);
        }

        async function stopAttendance() {
            try {
                const response = await fetch('/stop_attendance');
                const data = await response.json();
                if (data.status === 'success' || data.status === 'warning') {
                    isRunning = false;
                    clearInterval(attendanceInterval);
                    clearTimeout(autoStopTimeout);
                    showMessage(data.message, data.status);
                } else {
                    showMessage(data.message, 'warning');
                }
            } catch (error) {
                showMessage('Error stopping attendance system', 'danger');
            }
        }

        document.getElementById('startBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('/start_attendance');
                const data = await response.json();
                if (data.status === 'success') {
                    isRunning = true;
                    showMessage('Attendance system started - Webcam active!', 'success');
                    
                    // Set auto-stop after 20 minutes
                    autoStopTimeout = setTimeout(() => {
                        if (isRunning) {
                            showMessage('Auto-stopping attendance system after 20 minutes', 'warning');
                            stopAttendance();
                        }
                    }, 20 * 60 * 1000); // 20 minutes in milliseconds
                } else {
                    showMessage(data.message, 'warning');
                }
            } catch (error) {
                showMessage('Error starting attendance system', 'danger');
            }
        });

        document.getElementById('stopBtn').addEventListener('click', stopAttendance);

    </script>
</body>
</html>